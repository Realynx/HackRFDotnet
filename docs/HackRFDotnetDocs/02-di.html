<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>HackRfDotnet Using Dependency Injection | HackrfDotnet </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="HackRfDotnet Using Dependency Injection | HackrfDotnet ">
      
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      <meta name="docfx:rel" content="../">
      
      
      <meta name="docfx:docurl" content="https://github.com/Realynx/HackRFDotnet/blob/master/HackRFDotnetDocs/02-di.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
      <meta name="loc:downloadPdf" content="Download PDF">

      <script type="module" src="./../public/docfx.min.js"></script>

      <script>
        const theme = localStorage.getItem('theme') || 'auto'
        document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
      </script>

  </head>

  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="HackrfDotnet">
            HackrfDotnet
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
              <form class="search" role="search" id="search">
                <i class="bi bi-search"></i>
                <input class="form-control" id="search-query" type="search" disabled placeholder="Search" autocomplete="off" aria-label="Search">
              </form>
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="hackrfdotnet-using-dependency-injection">HackRfDotnet Using Dependency Injection</h1>

<p>HackRfDotnet is highly DI-friendly and provides extension methods for HostBuilder to configure single or multiple device access.
Below is a basic example using an analogue FM radio as an IHostedService to stream from a device stream singleton.</p>
<hr>
<h3 id="configure-the-hostbuilder">Configure the HostBuilder</h3>
<p>Configure the HostBuilder as shown in the example using UseFirstRadioDevice.
UseFirstRadioDevice is an extension method from HackRfDotnet that sets up single-device access. It adds an RfDevice singleton to the DI host. Adding this RfDevice also creates an IQ stream and opens the device RX, starting the flow of IQ samples into the ring buffer.</p>
<pre><code class="lang-cs">internal class Program {
    static async Task Main(string[] args) {
        // Create a new host builder.
        var appHost = new HostBuilder();
        appHost
            // Use HackRfDotnet's extension method to configure single device access.
            .UseFirstRadioDevice(SampleRate.FromMsps(20))
            .ConfigureServices(ConfigureServices);

        // Run the DI Host
        await appHost.RunConsoleAsync();
    }

    static void ConfigureServices(IServiceCollection serviceCollection) {
        // Configure additional services, FMRadioService in this case.
        serviceCollection
            .AddHostedService&lt;FmRadioService&gt;();
    }
}
</code></pre>
<h3 id="radio-service-consumer">Radio Service (Consumer)</h3>
<p>This is our FmRadioService, this is our IHostedService that actually starts the buffer feeding into NAudio.</p>
<pre><code class="lang-cs">internal class FmRadioService : IHostedService, IDisposable {
    private readonly IDigitalRadioDevice _radioDevice;
    private readonly FmSignalStream _signalStream;

    // We get IDigitalRadioDevice from the DI, as was prepared earlier for us by our &quot;UseFirstRadioDevice&quot;.
    public FmRadioService(IDigitalRadioDevice radioDevice) {
        _radioDevice = radioDevice;

        if (_radioDevice.DeviceStream is null) {
            throw new Exception(&quot;Radio device stream cannot be null!&quot;);
        }

        // Create a new FmSignalStream, this pre-configures a DSP chain for DM demodulation.
        _signalStream = new FmSignalStream(_radioDevice.DeviceStream, Bandwidth.FromKHz(200));
    }

    public void Dispose() {
        _signalStream.Dispose();
    }

    public Task StartAsync(CancellationToken cancellationToken) {
        _radioDevice.SetFrequency(Frequency.FromMHz(98.7f), Bandwidth.FromKHz(120));

        // Create an AnaloguePlayer and begin playing with NAudio.
        var fmPlayer = new AnaloguePlayer(_signalStream);
        fmPlayer.PlayStreamAsync(_radioDevice.Frequency, _radioDevice.Bandwidth, SampleRate.FromKsps(48));

        return Task.CompletedTask;
    }

    public Task StopAsync(CancellationToken cancellationToken) {
        throw new NotImplementedException();
    }
}
</code></pre>
<h1 id="di-and-single-device-access">DI and Single Device Access</h1>
<p>When you configure your HostBuilder with the <code>UseFirstRadioDevice</code> extension method, your DI container is populated with a fully initialized and connected RfDevice singleton. During the instantiation of the RfDevice, an IQ stream is automatically created, and streaming begins immediately. While the device resides in the DI container, it continuously maintains a ring buffer in the background, ensuring that IQ samples are always available for consumption by your hosted services.</p>
<h3 id="multi-device-access">Multi Device Access</h3>
<p>For scenarios involving multiple devices, you can use the <code>UseRfDeviceController</code> extension. This sets up a DeviceController service in your DI container, allowing your application to manage and interact with multiple connected devices. The DeviceController tracks all device instances, enabling you to reconnect to the same device across different hosted services, coordinate parallel streaming, and manage device lifecycles consistently.</p>
<hr>
<h2 id="di-runtime">DI Runtime</h2>
<p>The following graph illustrates the different DI states when using Multi-Device vs Single-Device HostBuilder configurations.</p>
<pre><code class="lang-mermaid">flowchart TD

subgraph multiDeviceGraph[Multi Device Setup]
    serviceProviderM(ServiceProvider)
    rfDeviceServiceM(IRfDeviceService)
    fmRadioServiceM(FmRadioService)


    serviceProviderM
    --&gt;|Singleton| rfDeviceServiceM

    rfDeviceServiceM
    --&gt; fmRadioServiceM

    serviceProviderM
    ---&gt;|IHostedService| fmRadioServiceM
end

subgraph singleDeviceGraph[Single Device Setup]
    serviceProvider(ServiceProvider)
    rfDeviceService(IRfDeviceService)
    digitalRadioDevice(IDigitalRadioDevice)
    fmRadioService(FmRadioService)


    serviceProvider
    --&gt;|singleton| rfDeviceService

    serviceProvider
    --&gt;|Singleton| digitalRadioDevice

    digitalRadioDevice
    --&gt; fmRadioService

    serviceProvider
    ---&gt;|IHostedService| fmRadioService
end

classDef Transparent fill:none, stroke: none

class singleDeviceGraph Transparent;
class multiDeviceGraph Transparent;
</code></pre>

</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/Realynx/HackRFDotnet/blob/master/HackRFDotnetDocs/02-di.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>

      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>

    <div class="container-xxl search-results" id="search-results"></div>

    <footer class="border-top text-secondary">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Github <a href="https://github.com/Realynx/HackRFDotnet">HackRfDotnet</a>.</span>
        </div>
      </div>
    </footer>
  </body>
</html>
